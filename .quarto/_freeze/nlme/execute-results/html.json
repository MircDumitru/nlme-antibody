{
  "hash": "304b7b012fec4e14dc8dfd662dbf8edf",
  "result": {
    "engine": "knitr",
    "markdown": "# NLME model - no covariates\n\n::: content-hidden\n$$\n\\newcommand{\\ab}{\\bm{a}}\n\\newcommand{\\Ab}{\\bm{A}}\n\\newcommand{\\arv}{\\mathrm{a}}\n\\newcommand{\\arvb}{\\mathbf{a}}\n\\newcommand{\\Arvb}{\\mathbf{A}}\n\n\\newcommand{\\bb}{\\bm{b}}\n\\newcommand{\\Bb}{\\bm{B}}\n\\newcommand{\\brv}{\\mathrm{b}}\n\\newcommand{\\brvb}{\\mathbf{b}}\n\\newcommand{\\Brvb}{\\mathbf{B}}\n\n\\newcommand{\\eb}{\\bm{e}}\n\\newcommand{\\Eb}{\\bm{E}}\n\\newcommand{\\erv}{\\mathrm{e}}\n\\newcommand{\\ervh}{\\widehat{\\mathrm{e}}}\n\\newcommand{\\ervb}{\\mathbf{e}}\n\\newcommand{\\Ervb}{\\mathbf{E}}\n\n\\newcommand{\\sb}{\\bm{s}}\n\\newcommand{\\Sb}{\\bm{S}}\n\\newcommand{\\srv}{\\mathrm{s}}\n\\newcommand{\\srvh}{\\widehat{\\mathrm{s}}}\n\\newcommand{\\srvb}{\\mathbf{s}}\n\\newcommand{\\Srv}{\\mathrm{S}}\n\\newcommand{\\Srvb}{\\mathbf{S}}\n\n\\newcommand{\\tb}{\\bm{t}}\n\\newcommand{\\Tb}{\\bm{T}}\n\\newcommand{\\trv}{\\mathrm{t}}\n\\newcommand{\\trvb}{\\mathbf{t}}\n\\newcommand{\\Trvb}{\\mathbf{T}}\n\n\\newcommand{\\ub}{\\bm{u}}\n\\newcommand{\\Ub}{\\bm{U}}\n\\newcommand{\\urv}{\\mathrm{u}}\n\\newcommand{\\urvb}{\\mathbf{u}}\n\\newcommand{\\Urvb}{\\mathbf{U}}\n\n\\newcommand{\\yb}{\\bm{y}}\n\\newcommand{\\Yb}{\\bm{Y}}\n\\newcommand{\\yrv}{\\mathrm{y}}\n\\newcommand{\\yrvh}{\\widehat{\\mathrm{y}}}\n\\newcommand{\\yrvb}{\\mathbf{y}}\n\\newcommand{\\Yrvb}{\\mathbf{Y}}\n\n\\newcommand{\\xb}{\\bm{x}}\n\\newcommand{\\Xb}{\\bm{X}}\n\\newcommand{\\xrv}{\\mathrm{x}}\n\\newcommand{\\xrvb}{\\mathbf{x}}\n\\newcommand{\\Xrvb}{\\mathbf{X}}\n\n\\newcommand{\\zb}{\\bm{z}}\n\\newcommand{\\Zb}{\\bm{Z}}\n\\newcommand{\\zrv}{\\mathrm{z}}\n\\newcommand{\\zrvb}{\\mathbf{z}}\n\\newcommand{\\Zrvb}{\\mathbf{Z}}\n\n\\newcommand{\\Ib}{\\bm{I}}\n\n\\newcommand{\\oneb}{\\bm{1}}\n\\newcommand{\\zerob}{\\bm{0}}\n\n\\newcommand{\\sigmah}{\\widehat{\\sigma}}\n\\newcommand{\\epsilonb}{\\bm{\\epsilon}}\n\\newcommand{\\epsilonh}{\\widehat{\\epsilon}}\n\\newcommand{\\tauh}{\\widehat{\\tau}}\n\\newcommand{\\taus}{\\tau^{*}}\n\\newcommand{\\taush}{\\widehat{\\tau}^{*}}\n\\newcommand{\\alphah}{\\widehat{\\alpha}}\n\\newcommand{\\alphas}{\\alpha^{*}}\n\\newcommand{\\alphash}{\\widehat{\\alpha}^{*}}\n\\newcommand{\\nuh}{\\widehat{\\nu}}\n\\newcommand{\\betab}{\\bm{\\beta}}\n\\newcommand{\\psib}{\\bm{\\psi}}\n\\newcommand{\\xib}{\\bm{\\xi}}\n\\newcommand{\\thetab}{\\bm{\\theta}}\n\\newcommand{\\betah}{\\widehat{\\beta}}\n\\newcommand{\\betas}{\\beta^{*}}\n\\newcommand{\\betabh}{\\widehat{\\betab}}\n\\newcommand{\\betabsh}{\\widehat{\\betab}^{*}}\n\\newcommand{\\betabst}{\\betab^{*T}}\n\\newcommand{\\betabht}{\\widehat{\\betab}^{T}}\n\n\\def\\PD#1{\\mathbb{P} \\left( #1 \\right)}\n\\def\\cond{\\,\\middle\\vert\\,}\n\\def\\indep{\\perp \\!\\!\\!\\! \\perp}\n\\def\\Abs#1{\\left\\lvert\\ #1 \\right\\rvert}\n\\def\\EV#1{\\mathbb{E}\\left[#1\\right]}\n\\def\\EVp#1#2{\\mathbb{E}^{#1}\\left[#2\\right]}\n\\def\\ExV#1#2{\\mathbb{E}_{#1}\\left[#2\\right]}\n\\def\\ExVa#1#2#3{\\mathbb{E}_{#1}^{#2}\\left[#3\\right]}\n\\def\\Var#1{\\mathbb{V}\\left[#1\\right]}\n\\def\\Varh#1{\\widehat{\\mathbb{V}}\\left[#1\\right]}\n\\def\\VarRV#1#2{\\mathbb{V}_{#1}\\left[#2\\right]}\n\\def\\VarhRV#1#2{\\widehat{\\mathbb{V}}_{#1}\\left[#2\\right]}\n\\def\\VarRVh#1#2{\\widehat{\\mathbb{V}}_{#1}\\left[#2\\right]}\n\\def\\Cov#1{\\text{Cov}\\left[#1\\right]}\n\\def\\CovRV#1#2{\\text{Cov}_{#1}\\left[#2\\right]}\n\\def\\d#1{\\text{d}#1}\n\n\\def\\bias#1{\\text{bias}\\left[#1\\right]}\n\\def\\MSE#1{\\text{MSE}\\left(#1\\right)}\n\\def\\MSEh#1{\\widehat{\\text{MSE}}\\left(#1\\right)}\n\n\n\\def\\transpose#1{#1^{\\mathrm{T}}}\n\\def\\Normal#1{\\mathcal N \\left( #1 \\right)}\n\n\\usepackage{amsmath} \n\\usepackage{amsthm} \n\\usepackage{units}\n\\usepackage{bm}\n\\usepackage{bbm}\n\\usepackage{enumitem}\n\\usepackage{mathabx}\n\n\n$$\n:::\n\n\n::: {.cell}\n\n:::\n\n\n## Introduction\n\n### Prerequisites\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)  # tidyverse \nlibrary(nlme)       # non-linear mixed effect models\nlibrary(saemix)     # nlme package for saemix objects\n```\n:::\n\n\n\n## NLME with no covariates\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ntb <- read_csv(\"data/data_ebola_ab.csv\")\n\ntb <- tb |>\n  # clean the names\n  janitor::clean_names() |>\n  # transform chr into factors\n  mutate(across(where(is.character), fct))\n\ntb_clean <- tb |>\n  filter(age >= 0)\n\ntb_clean <- tb_clean |>\n  mutate(age_updated = age + time / 365) |>\n  relocate(age_updated, .after = age)\n\ntb_after_7 <- tb_clean |>\n  filter(time != 0)\n```\n:::\n\n\n\n\nWill be done via stochastic approximation expectation maximization (SAEM) using the `saemix` package.\n\nFirst thing: account for the specificity of `saemix` which expects the `id` column in the data frame to be of numerical type. The next chunk is re-transforming the `id` column in the tibble into a numerical variable and parse the numerical value (i.e. removes \"ID\" from \"IDi\")\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ntb_after_7 <- tb_after_7 |>\n  mutate(\n    id = parse_number(as.character(id))\n    )\ntb_after_7\n#> # A tibble: 301 × 8\n#>      id  time sex      age age_updated   bmi country     abelisa\n#>   <dbl> <dbl> <fct>  <dbl>       <dbl> <dbl> <fct>         <dbl>\n#> 1     1     7 Female  35.5        35.5  20.7 West Africa    4.43\n#> 2     1    15 Female  35.5        35.5  20.7 West Africa    4.12\n#> 3     1    30 Female  35.5        35.6  20.7 West Africa    4.05\n#> 4     1    90 Female  35.5        35.7  20.7 West Africa    3.38\n#> 5     1   180 Female  35.5        36.0  20.7 West Africa    2.94\n#> 6     1   365 Female  35.5        36.5  20.7 West Africa    2.61\n#> # ℹ 295 more rows\n```\n:::\n\n\n\nThe next chunk is defining the data as a `saemix` object, via `saemixData`. \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nsaemix_data_nlme <- saemixData(\n  name.data = tb_after_7,\n  name.group = \"id\",\n  name.predictors = \"time\",\n  name.response = \"abelisa\",\n  units = list(x = \"Days\", y = \"EU/ml\")\n)\n#> Using the object called tb_after_7 in this R session as the data.\n#> \n#> \n#> The following SaemixData object was successfully created:\n#> \n#> Object of class SaemixData\n#>     longitudinal data for use with the SAEM algorithm\n#> Dataset tb_after_7 \n#>     Structured data: abelisa ~ time | id \n#>     Predictor: time (Days)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsaemix_data_nlme\n#> Object of class SaemixData\n#>     longitudinal data for use with the SAEM algorithm\n#> Dataset tb_after_7 \n#>     Structured data: abelisa ~ time | id \n#> 301     observations in 43 subjects\n#> First lines of data:\n#>    id time  abelisa mdv cens occ ytype\n#> 1   1    7 4.434471   0    0   1     1\n#> 2   1   15 4.124822   0    0   1     1\n#> 3   1   30 4.050954   0    0   1     1\n#> 4   1   90 3.382073   0    0   1     1\n#> 5   1  180 2.935390   0    0   1     1\n#> 6   1  365 2.606559   0    0   1     1\n#> 7   1  730 2.308632   0    0   1     1\n#> 8   2    7 3.664922   0    0   1     1\n#> 9   2   15 4.143873   0    0   1     1\n#> 10  2   30 3.967767   0    0   1     1\n```\n:::\n\n\nThe next chunk implements the function from @eq-f-approx:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nfunction_approx <- function(psi, id, xidep){\n  time <- xidep[, 1]\n  y_min <- psi[id, 1]\n  y_max <- psi[id, 2]\n  rate <- psi[id, 3]\n  fpred <- y_min + (y_max - y_min) * exp(-rate * time)\n  return(fpred)\n}\n#function_approx\n```\n:::\n\n\nThe next chunk is defining the nlme model as a `saemix` object, via `saemixModel` function. The model is given by @eq-f-approx, the initial values for $\\phi_1$ and $\\phi_2$ are set via the range computed over the complete data and the rate $r$ is set at $0.05$. The model considers random effects on all three parameters & constant variance, `error.model = \"constant\"`. \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nsaemix_model_nlme <- saemixModel(\n  model = function_approx,\n  description = \"Approx function\", \n  psi0 = matrix(\n    c(1.6, 4.9, 0.05),\n    ncol = 3, \n    byrow = TRUE, \n    dimnames = list(NULL, c(\"y_min\", \"y_max\", \"rate\"))),\n  transform.par = c(0, 0, 1),   # log-transform rate only\n  covariance.model = diag(1, 3),  # random effects on all\n  error.model = \"constant\"\n  )\n#> \n#> \n#> The following SaemixModel object was successfully created:\n#> \n#> Nonlinear mixed-effects model\n#>   Model function:  Approx function\n#> function(psi, id, xidep){\n#>   time <- xidep[, 1]\n#>   y_min <- psi[id, 1]\n#>   y_max <- psi[id, 2]\n#>   rate <- psi[id, 3]\n#>   fpred <- y_min + (y_max - y_min) * exp(-rate * time)\n#>   return(fpred)\n#> }\n#>   Nb of parameters: 3 \n#>       parameter names:  y_min y_max rate \n#>       distribution:\n#>      Parameter Distribution Estimated\n#> [1,] y_min     normal       Estimated\n#> [2,] y_max     normal       Estimated\n#> [3,] rate      log-normal   Estimated\n#>   Variance-covariance matrix:\n#>       y_min y_max rate\n#> y_min     1     0    0\n#> y_max     0     1    0\n#> rate      0     0    1\n#>   Error model: constant , initial values: a.=1 \n#>     No covariate in the model.\n#>     Initial values\n#>              y_min y_max rate\n#> Pop.CondInit   1.6   4.9 0.05\n# saemix_model_nlme\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsaemix_model_nlme\n#> Nonlinear mixed-effects model\n#>   Model function:  Approx function \n#>      3 parameters: y_min y_max rate \n#>      error model: constant \n#> No covariate\n```\n:::\n\n\nThe next chunk is defining the nlme model's parameters as a (regular R) list:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nsaemix_options_nlme <- list(\n  seed = 42,\n  save = FALSE, \n  save.graph = FALSE,\n  displayProgress = FALSE,\n  print = FALSE\n  )\n#saemix_options_nlme\n```\n:::\n\n\nThe next chunk is fitting the nlme model, a `saemix` object, created via `saemix` function.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nsaemix_fit_nlme <- saemix(\n  saemix_model_nlme,\n  saemix_data_nlme,\n  saemix_options_nlme\n  )\n#> Plotting the data\n#> Plotting convergence plots\n#> Plotting the likelihood\n#> Plotting observations versus predictions\n#> Plotting individual fits\n# saemix_fit_nlme\n```\n:::\n\n\nThe results are\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsaemix_fit_nlme@results\n#> Fixed effects\n#>  Parameter Estimate   SE      CV(%)\n#>  y_min     2.71864  0.051789 1.90  \n#>  y_max     4.22622  0.049438 1.17  \n#>  rate      0.00891  0.000761 8.54  \n#>  a.        0.25728  0.013047 5.07  \n#> \n#> Variance of random effects\n#>  Parameter    Estimate   SE    CV(%)\n#>  omega2.y_min 0.0712   0.0214  30.1 \n#>  omega2.y_max 0.0596   0.0198  33.3 \n#>  omega2.rate  0.0398   0.0499 125.5 \n#> \n#> Statistical criteria\n#> Likelihood computed by linearisation\n#>       -2LL= 152.3174 \n#>        AIC= 166.3174 \n#>        BIC= 178.6458 \n#> Likelihood computed by importance sampling\n#>       -2LL= 152.5252 \n#>        AIC= 166.5252 \n#>        BIC= 178.8536\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsaemix_fit_nlme@results@fixed.effects\n#> [1] 2.718639913 4.226219354 0.008911517\n```\n:::\n\n\nThe following chunk plots the comparison between the observed and the (individual and population) prediction for subject 1:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nfit_with_preds <- saemix.predict(saemix_fit_nlme)\ntb_data <- fit_with_preds@data@data\ntb_predictions <- fit_with_preds@results@predictions\n\ntb_complete <- cbind(tb_data, tb_predictions)\n\nggplot(subset(tb_complete, id == 1), aes(x = time)) +\n  geom_point(aes(y = abelisa, color = \"Observed\"), size = 2) +\n  geom_line(aes(y = ipred, color = \"Individual prediction\"), linewidth = 1.5) +\n  geom_line(aes(y = ypred, color = \"Population prediction\"), linewidth = 1.5, linetype = \"dashed\") +\n  scale_color_manual(\n    name = NULL,\n    values = c(\n      \"Observed\" = \"tomato\",\n      \"Individual prediction\" = \"darkseagreen\",\n      \"Population prediction\" = \"violet\"\n    )\n  ) +\n  labs(\n    title = str_c(\"Subject\", 1, \": Obseved vs. Prediction\", sep = \" \"),\n    x = \"Time\",\n    y = \"Antibody levels (EU/ml)\"\n  ) +\n  theme_bw() +\n  theme(\n    legend.direction = \"horizontal\",\n    legend.position = \"bottom\",\n  )\n```\n\n::: {.cell-output-display}\n![](nlme_files/figure-html/unnamed-chunk-14-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nThe following chunk plots the comparison between the observed and the (individual and population) prediction for the subjects in the data set. \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(tb_complete, aes(x = time)) +\n  geom_point(aes(y = abelisa), color = \"tomato\", size = 2) +\n  geom_line(aes(y = ipred), color = \"darkseagreen\", linewidth = 1.5) +\n  geom_line(aes(y = ypred), color = \"violet\", linewidth = 1.5, linetype = \"dashed\") +\n  labs(\n    title = NULL,\n    x = NULL,\n    y = NULL\n  ) +\n  facet_wrap(~ id) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](nlme_files/figure-html/unnamed-chunk-15-1.png){fig-align='center' width=1152}\n:::\n:::\n\n::: {#fig-fixed-effects-iterations .cell layout-ncol=\"3\" layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\npsi <- psi(saemix_fit_nlme) |>\n  as_tibble() |>\n  rowid_to_column(\"iteration\")\n\npsi |>\n  ggplot(aes(x = iteration, y = y_min)) +\n  geom_line(color = \"tomato\") +\n  labs(\n    x = \"Iteration\",\n    y = \"y_min\"    \n  ) +\n  theme_bw()\n\npsi |>\n  ggplot(aes(x = iteration, y = y_max)) +\n  geom_line(color = \"tomato\") +\n  labs(\n    x = \"Iteration\",\n    y = \"y_max\"    \n  ) +\n  theme_bw()\n\npsi |>\n  ggplot(aes(x = iteration, y = rate)) +\n  geom_line(color = \"tomato\") +\n  labs(\n    x = \"Iteration\",\n    y = \"rate\"    \n  ) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![y_min](nlme_files/figure-html/fig-fixed-effects-iterations-1.png){#fig-fixed-effects-iterations-1 fig-align='center' width=288}\n:::\n\n::: {.cell-output-display}\n![y_max](nlme_files/figure-html/fig-fixed-effects-iterations-2.png){#fig-fixed-effects-iterations-2 fig-align='center' width=288}\n:::\n\n::: {.cell-output-display}\n![rate](nlme_files/figure-html/fig-fixed-effects-iterations-3.png){#fig-fixed-effects-iterations-3 fig-align='center' width=288}\n:::\n\nFixed effects during iterations\n:::\n",
    "supporting": [
      "nlme_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}