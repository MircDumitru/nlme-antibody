## Non-linear mixed effects (NLME) model - covariates


::: content-hidden
$$
{{< include _macros.tex >}}
{{< include _packages.tex >}}
$$
:::

```{r}
#| echo: false

source("_settings.R")
```

## Introduction

### Prerequisites

```{r}
#| warning: false
#| message: false

library(tidyverse)  # tidyverse 
library(nlme)       # non-linear mixed effect models
library(saemix)     # nlme package for saemix objects
```


## NLME with covariates

The decay rate $\phi_3$ is assumed to depend on `age` through a linear relationship on the log scale, i.e. 

$$
\begin{equation}
\log(\psi^{i}_3)
=
\log(\psi_3)
+
\beta_{\text{age}}
\left(
\text{age}_i
-
\overline{\text{age}}
\right)
+
\nu_{3}
.
\end{equation}
$${#eq-log-scale-regression-age}

```{r}
#| code-fold: true
#| message: false
#| warning: false

tb <- read_csv("data/data_ebola_ab.csv")

tb <- tb |>
  # clean the names
  janitor::clean_names() |>
  # transform chr into factors
  mutate(across(where(is.character), fct))

tb_clean <- tb |>
  filter(age >= 0)

tb_clean <- tb_clean |>
  mutate(age_updated = age + time / 365) |>
  relocate(age_updated, .after = age)

tb_after_7 <- tb_clean |>
  filter(time != 0)
```

The next chunk is centering the age.


```{r}
#| code-fold: true

# Centering the age covariate 
tb_after_7 <- tb_after_7 |>
  mutate(age_centered = age - mean(age, na.rm = TRUE))
```

The next chunk implements the function from @eq-f-approx

```{r}
#| code-fold: true

function_approx <- function(psi, id, xidep) {
  time <- xidep[, 1]
  y_min <- psi[id, 1]
  y_max <- psi[id, 2]
  rate  <- psi[id, 3]
  fpred <- y_min + (y_max - y_min) * exp(-rate * time)
  return(fpred)
}
```

The next chunk is defining the data as a `saemix` object, via `saemixData()` function.

```{r}
#| code-fold: true

saemix_data_nlme <- saemixData(
  name.data = tb_after_7,
  name.group = "id",
  name.predictors = "time",
  name.response = "abelisa",
  name.covariates = "age_centered",
  units = list(x = "Days", y = "EU/ml")
)
```

```{r}
saemix_data_nlme
```

The next chunk is defining the nlme model as a `saemix` object, via `saemixModel()` function. The model is given by @eq-f-approx, the initial values for $\psi_1$ and $\psi_2$ are set via the range computed over the complete data and the rate $\psi_3$ is set at $0.05$. The model considers random effects on all three parameters & constant variance, `error.model = "constant"`. Covariate (`age`) is considered to have an effect over the rate.


```{r}
#| code-fold: true

psi0_matrix <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.0, 0.01), # covariate effect on rate only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

covariate_model_matrix <- matrix(
  data = c(0, 0, 1),
  nrow = 1,
  ncol = 3,
  dimnames = list("age_centered", c("y_min", "y_max", "rate"))
)

saemix_model_nlme <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix,
  error.model = "constant"
)
```

```{r}
saemix_model_nlme
```


The next chunk is defining the nlme modelâ€™s parameters as a (regular R) list (this doesn't change with respect to the no covariates model's implementation).

```{r}
#| code-fold: true

saemix_options_nlme <- list(
  seed = 42,
  save = FALSE,
  save.graph = FALSE,
  displayProgress = FALSE,
  print = FALSE
)
```

The next chunk is fitting the nlme model, a `saemix` object, created via `saemix()` function.

```{r}
#| code-fold: true

saemix_fit_nlme <- saemix(
  saemix_model_nlme,
  saemix_data_nlme,
  saemix_options_nlme
)
```

```{r}
# Fixed effects and covariate effects
saemix_fit_nlme@results
```

```{r}
# Fixed effects and covariate effects
saemix_fit_nlme@results@fixed.effects
```


```{r}
#| code-fold: true

fit_with_preds <- saemix.predict(saemix_fit_nlme)
tb_data <- fit_with_preds@data@data
tb_predictions <- fit_with_preds@results@predictions

tb_complete <- cbind(tb_data, tb_predictions)
```

```{r}
#| code-fold: true

tb_complete |>
  filter(id == 1) |>
ggplot(aes(x = time)) +
  geom_point(aes(y = abelisa, color = "Observed"), size = 2) +
  geom_line(aes(y = ipred, color = "Individual prediction"), linewidth = 1.5) +
  geom_line(aes(y = ypred, color = "Population prediction"), linewidth = 1.5, linetype = "dashed") +
  scale_color_manual(
    name = NULL,
    values = c("Observed" = "tomato", "Individual prediction" = "darkseagreen", "Population prediction" = "violet")
  ) +
  labs(
    title = "Subject 1: Observed vs. Predicted",
    x = "Time (Days)",
    y = "Antibody Level (EU/ml)"
  ) +
  theme_bw() +
  theme(legend.position = "bottom")
```

```{r}
#| code-fold: true
#| warning: false
#| fig-width: 12
#| fig-height: 10

ggplot(tb_complete, aes(x = time)) +
  geom_point(aes(y = abelisa), color = "tomato", size = 2) +
  geom_line(aes(y = ipred), color = "darkseagreen", linewidth = 1.5) +
  geom_line(aes(y = ypred), color = "violet", linewidth = 1.5, linetype = "dashed") +
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  facet_wrap(~ id) +
  theme_bw()
```  


```{r}
#| code-fold: true
#| label: fig-fixed-effects-iterations
#| fig-cap: "Fixed effects during iterations"
#| fig-subcap: 
#|   - "y_min"
#|   - "y_max"
#|   - "rate"
#| fig-width: 3
#| layout-ncol: 3

psi <- psi(saemix_fit_nlme) |>
  as_tibble() |>
  rowid_to_column("iteration")

psi |>
  ggplot(aes(x = iteration, y = y_min)) +
  geom_line(color = "tomato") +
  labs(
    x = "Iteration",
    y = "y_min"    
  ) +
  theme_bw()

psi |>
  ggplot(aes(x = iteration, y = y_max)) +
  geom_line(color = "tomato") +
  labs(
    x = "Iteration",
    y = "y_max"    
  ) +
  theme_bw()

psi |>
  ggplot(aes(x = iteration, y = rate)) +
  geom_line(color = "tomato") +
  labs(
    x = "Iteration",
    y = "rate"    
  ) +
  theme_bw()
```


## Model selection

```{r}
#| code-fold: true

# Centering the bmi covariate 
tb_after_7 <- tb_after_7 |>
  mutate(bmi_centered = bmi - mean(bmi, na.rm = TRUE))
```


### Age centered

```{r}
#| code-fold: true
#| message: false

# Define models with main effects
saemix_data_nlme_age <- saemixData(
  name.data = tb_after_7,
  name.group = "id",
  name.predictors = "time",
  name.response = "abelisa",
  name.covariates = "age_centered",
  units = list(x = "Days", y = "EU/ml")
)

covariate_model_matrix_rate <- matrix(
  data = c(0, 0, 1),
  nrow = 1,
  ncol = 3,
  dimnames = list("age_centered", c("y_min", "y_max", "rate"))
)

psi0_matrix_rate <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.0, 0.01), # covariate effect on rate only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_rate <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_rate,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_rate,
  error.model = "constant"
)

saemix_fit_nlme_age_rate <- saemix(
  saemix_model_nlme_rate,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_rate@results

#----

covariate_model_matrix_y_max <- matrix(
  data = c(0, 1, 0),
  nrow = 1,
  ncol = 3,
  dimnames = list("age_centered", c("y_min", "y_max", "rate"))
)

psi0_matrix_y_max <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.01, 0.0), # covariate effect on y_max only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_y_max <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_y_max,
  transform.par = c(0, 1, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_y_max,
  error.model = "constant"
)

saemix_fit_nlme_age_y_max <- saemix(
  saemix_model_nlme_y_max,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_y_max@results

#----

covariate_model_matrix_y_min <- matrix(
  data = c(1, 0, 0),
  nrow = 1,
  ncol = 3,
  dimnames = list("age_centered", c("y_min", "y_max", "rate"))
)

psi0_matrix_y_min <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.01, 0.0, 0.0), # covariate effect on y_min only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_y_min <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_y_min,
  transform.par = c(1, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_y_min,
  error.model = "constant"
)

saemix_fit_nlme_age_y_min <- saemix(
  saemix_model_nlme_y_min,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_y_min@results
```



```{r}
saemix_fit_nlme_age_rate@results
```

```{r}
saemix_fit_nlme_age_y_max@results
```

```{r}
saemix_fit_nlme_age_y_min@results
```






### Age 

```{r}
#| code-fold: true
#| message: false

# Define models with main effects
saemix_data_nlme_age <- saemixData(
  name.data = tb_after_7,
  name.group = "id",
  name.predictors = "time",
  name.response = "abelisa",
  name.covariates = "age",
  units = list(x = "Days", y = "EU/ml")
)

covariate_model_matrix_rate <- matrix(
  data = c(0, 0, 1),
  nrow = 1,
  ncol = 3,
  dimnames = list("age", c("y_min", "y_max", "rate"))
)

psi0_matrix_rate <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.0, 0.01), # covariate effect on rate only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_rate <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_rate,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_rate,
  error.model = "constant"
)

saemix_fit_nlme_age_rate <- saemix(
  saemix_model_nlme_rate,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_rate@results

#----

covariate_model_matrix_y_max <- matrix(
  data = c(0, 1, 0),
  nrow = 1,
  ncol = 3,
  dimnames = list("age", c("y_min", "y_max", "rate"))
)

psi0_matrix_y_max <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.01, 0.0), # covariate effect on y_max only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_y_max <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_y_max,
  transform.par = c(0, 1, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_y_max,
  error.model = "constant"
)

saemix_fit_nlme_age_y_max <- saemix(
  saemix_model_nlme_y_max,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_y_max@results

#----

covariate_model_matrix_y_min <- matrix(
  data = c(1, 0, 0),
  nrow = 1,
  ncol = 3,
  dimnames = list("age", c("y_min", "y_max", "rate"))
)

psi0_matrix_y_min <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.01, 0.0, 0.0), # covariate effect on y_min only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_y_min <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_y_min,
  transform.par = c(1, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_y_min,
  error.model = "constant"
)

saemix_fit_nlme_age_y_min <- saemix(
  saemix_model_nlme_y_min,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_y_min@results
```



```{r}
saemix_fit_nlme_age_rate@results
```

```{r}
saemix_fit_nlme_age_y_max@results
```

```{r}
saemix_fit_nlme_age_y_min@results
```


### BMI 

```{r}
#| code-fold: true
#| message: false

# Define models with main effects
saemix_data_nlme_age <- saemixData(
  name.data = tb_after_7,
  name.group = "id",
  name.predictors = "time",
  name.response = "abelisa",
  name.covariates = "bmi",
  units = list(x = "Days", y = "EU/ml")
)

covariate_model_matrix_rate <- matrix(
  data = c(0, 0, 1),
  nrow = 1,
  ncol = 3,
  dimnames = list("bmi", c("y_min", "y_max", "rate"))
)

psi0_matrix_rate <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.0, 0.01), # covariate effect on rate only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_rate <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_rate,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_rate,
  error.model = "constant"
)

saemix_fit_nlme_age_rate <- saemix(
  saemix_model_nlme_rate,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_rate@results

#----

covariate_model_matrix_y_max <- matrix(
  data = c(0, 1, 0),
  nrow = 1,
  ncol = 3,
  dimnames = list("bmi", c("y_min", "y_max", "rate"))
)

psi0_matrix_y_max <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.01, 0.0), # covariate effect on y_max only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_y_max <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_y_max,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_y_max,
  error.model = "constant"
)

saemix_fit_nlme_age_y_max <- saemix(
  saemix_model_nlme_y_max,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_y_max@results

#----

covariate_model_matrix_y_min <- matrix(
  data = c(1, 0, 0),
  nrow = 1,
  ncol = 3,
  dimnames = list("bmi", c("y_min", "y_max", "rate"))
)

psi0_matrix_y_min <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.01, 0.0, 0.0), # covariate effect on y_min only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_y_min <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_y_min,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_y_min,
  error.model = "constant"
)

saemix_fit_nlme_age_y_min <- saemix(
  saemix_model_nlme_y_min,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_y_min@results
```


```{r}
saemix_fit_nlme_age_rate@results
```

```{r}
saemix_fit_nlme_age_y_max@results
```

```{r}
saemix_fit_nlme_age_y_min@results
```


### Sex 

```{r}
#| code-fold: true
#| message: false

# Define models with main effects
saemix_data_nlme_age <- saemixData(
  name.data = tb_after_7,
  name.group = "id",
  name.predictors = "time",
  name.response = "abelisa",
  name.covariates = "sex",
  units = list(x = "Days", y = "EU/ml")
)

covariate_model_matrix_rate <- matrix(
  data = c(0, 0, 1),
  nrow = 1,
  ncol = 3,
  dimnames = list("sex", c("y_min", "y_max", "rate"))
)

psi0_matrix_rate <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.0, 0.01), # covariate effect on rate only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_rate <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_rate,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_rate,
  error.model = "constant"
)

saemix_fit_nlme_age_rate <- saemix(
  saemix_model_nlme_rate,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_rate@results

#----

covariate_model_matrix_y_max <- matrix(
  data = c(0, 1, 0),
  nrow = 1,
  ncol = 3,
  dimnames = list("sex", c("y_min", "y_max", "rate"))
)

psi0_matrix_y_max <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.01, 0.0), # covariate effect on y_max only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_y_max <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_y_max,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_y_max,
  error.model = "constant"
)

saemix_fit_nlme_age_y_max <- saemix(
  saemix_model_nlme_y_max,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_y_max@results

#----

covariate_model_matrix_y_min <- matrix(
  data = c(1, 0, 0),
  nrow = 1,
  ncol = 3,
  dimnames = list("sex", c("y_min", "y_max", "rate"))
)

psi0_matrix_y_min <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.01, 0.0, 0.0), # covariate effect on y_min only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_y_min <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_y_min,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_y_min,
  error.model = "constant"
)

saemix_fit_nlme_age_y_min <- saemix(
  saemix_model_nlme_y_min,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_y_min@results
```


```{r}
saemix_fit_nlme_age_rate@results
```

```{r}
saemix_fit_nlme_age_y_max@results
```

```{r}
saemix_fit_nlme_age_y_min@results
```



### Country 

```{r}
#| code-fold: true
#| message: false

# Define models with main effects
saemix_data_nlme_age <- saemixData(
  name.data = tb_after_7,
  name.group = "id",
  name.predictors = "time",
  name.response = "abelisa",
  name.covariates = "country",
  units = list(x = "Days", y = "EU/ml")
)

covariate_model_matrix_rate <- matrix(
  data = c(0, 0, 1),
  nrow = 1,
  ncol = 3,
  dimnames = list("country", c("y_min", "y_max", "rate"))
)

psi0_matrix_rate <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.0, 0.01), # covariate effect on rate only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_rate <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_rate,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_rate,
  error.model = "constant"
)

saemix_fit_nlme_age_rate <- saemix(
  saemix_model_nlme_rate,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_rate@results

#----

covariate_model_matrix_y_max <- matrix(
  data = c(0, 1, 0),
  nrow = 1,
  ncol = 3,
  dimnames = list("country", c("y_min", "y_max", "rate"))
)

psi0_matrix_y_max <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.0, 0.01, 0.0), # covariate effect on y_max only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_y_max <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_y_max,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_y_max,
  error.model = "constant"
)

saemix_fit_nlme_age_y_max <- saemix(
  saemix_model_nlme_y_max,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_y_max@results

#----

covariate_model_matrix_y_min <- matrix(
  data = c(1, 0, 0),
  nrow = 1,
  ncol = 3,
  dimnames = list("country", c("y_min", "y_max", "rate"))
)

psi0_matrix_y_min <- matrix(
  c(1.6, 4.9, 0.05,  # fixed effects: y_min, y_max, rate
    0.01, 0.0, 0.0), # covariate effect on y_min only
  nrow = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("y_min", "y_max", "rate"))
)

saemix_model_nlme_y_min <- saemixModel(
  model = function_approx,
  description = "Antibody decay model with age covariate",
  psi0 = psi0_matrix_y_min,
  transform.par = c(0, 0, 1),           # log-transform rate
  covariance.model = diag(1, 3),
  covariate.model = covariate_model_matrix_y_min,
  error.model = "constant"
)

saemix_fit_nlme_age_y_min <- saemix(
  saemix_model_nlme_y_min,
  saemix_data_nlme_age,
  saemix_options_nlme
)

saemix_fit_nlme_age_y_min@results
```


```{r}
saemix_fit_nlme_age_rate@results
```

```{r}
saemix_fit_nlme_age_y_max@results
```

```{r}
saemix_fit_nlme_age_y_min@results
```



